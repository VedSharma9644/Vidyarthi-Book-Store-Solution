@{
    ViewData["Title"] = "Shop";
    var headerModel = new PageHeaderDto
            {
                Title = "Shop",
                Breadcrumbs = new List<Breadcrumb>
        {
            new Breadcrumb { Text = "Shop", IsActive = true }
        }
            };
}
<!-- Header Section -->
<partial name="_PageHeader" model="headerModel" />

<section class="pt-5 bg-light p-2">
    <div class="container">
        <!-- Filter & Sort Row -->
        <div class="row mb-4 ">
            <div class="col-md-3 mb-3">
                <select class="form-select" id="category-filter">
                    <option value="">Filter by Category</option>
                    <option value="Books">Books</option>
                    <option value="Accessories">Accessories</option>
                    <option value="Cricket Kits">Cricket Kits</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select class="form-select" id="price-filter">
                    <option value="">Filter by Price</option>
                    <option value="under-50">Under $50</option>
                    <option value="50-100">$50 - $100</option>
                    <option value="100-plus">$100+</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select class="form-select" id="rating-filter">
                    <option value="">Filter by Rating</option>
                    <option value="4">4 Stars & Up</option>
                    <option value="3">3 Stars & Up</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <select class="form-select" id="sort-filter">
                    <option value="">Sort by</option>
                    <option value="price-asc">Price: Low to High</option>
                    <option value="price-desc">Price: High to Low</option>
                    <option value="newest">Newest</option>
                </select>
            </div>
        </div>

        <!-- Product List -->
        <div class="text-center my-4" id="loading-spinner" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <div class="row" id="product-wrapper">
            <!-- Products will be loaded here dynamically -->
        </div>
        <!--------------Pagination---->
        <div id="pagination-info" style="margin-top: 1rem;"></div>

    </div>
</section>

@section Scripts {
    <script>
            let offset = 0;
        const limit = 8;
        let loading = false;
        let allLoaded = false;

        document.addEventListener("DOMContentLoaded", function () {
            loadBooks();

            document.querySelectorAll("#category-filter, #price-filter, #rating-filter, #sort-filter")
                .forEach(el => el.addEventListener("change", () => {
                    offset = 0;
                    allLoaded = false;
                    document.getElementById("product-wrapper").innerHTML = "";
                    loadBooks();
                }));

            window.addEventListener("scroll", () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                    if (!loading && !allLoaded) {
                        loadBooks();
                    }
                }
            });
        });

        function getFilters() {
            return {
                category: document.getElementById("category-filter").value,
                price: document.getElementById("price-filter").value,
                sort: document.getElementById("sort-filter").value
            };
        }

        function showSpinner() {
            document.getElementById("loading-spinner").style.display = "block";
        }

        function hideSpinner() {
            document.getElementById("loading-spinner").style.display = "none";
        }

        function loadBooks() {
            const { category, price, sort } = getFilters();
            loading = true;
            showSpinner();

            const url = new URL("/api/books/get-all-books", window.location.origin);
            url.searchParams.append("offset", offset);
            url.searchParams.append("limit", limit);
            if (category) url.searchParams.append("category", category);
            if (price) url.searchParams.append("price", price);
            if (sort) url.searchParams.append("sort", sort);

            fetch(url)
                .then(response => response.json())
                .then(result => {
                    const books = result.data;
                    const wrapper = document.getElementById("product-wrapper");

                    if (books.length === 0 && offset === 0) {
                        wrapper.innerHTML = "<p>No books found.</p>";
                        allLoaded = true;
                    } else {
                        books.forEach(book => {
                            wrapper.innerHTML += `
                                <div class="col-md-3 mb-3 col-6">
                                    <div class="card position-relative p-4 border rounded-3">
                                        <h6 class="mt-4 mb-0 fw-bold"><a href="#">${book.title}</a></h6>
                                        <span class="price text-primary fw-bold mb-2 fs-5">₹${book.price}</span>
                                    </div>
                                </div>`;
                        });

                        if (books.length < limit) {
                            allLoaded = true;
                        } else {
                            offset += limit;
                        }
                    }

                    document.getElementById("pagination-info").textContent = `Loaded ${offset + books.length} books`;
                })
                .catch(error => {
                    console.error("Error loading books:", error);
                    document.getElementById("product-wrapper").innerHTML += "<p>Error loading books.</p>";
                })
                .finally(() => {
                    loading = false;
                    hideSpinner();
                });
        }
    </script>
}

